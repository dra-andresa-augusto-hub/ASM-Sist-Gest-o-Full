<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica PRO - Multi-Usu√°rio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --navy: #1a237e;
            --navy-light: #283593;
            --gold: #ffd700;
            --gold-dark: #ffb300;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --success: #4caf50;
            --danger: #f44336;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, #0d1642 100%);
            min-height: 100vh;
            color: #333;
        }
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-box {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 3px solid var(--gold);
        }
        .auth-logo { text-align: center; margin-bottom: 30px; }
        .auth-logo h1 { color: var(--navy); font-size: 28px; margin-bottom: 10px; }
        .auth-logo p { color: var(--gold-dark); font-weight: bold; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--navy); font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--navy); }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(26, 35, 126, 0.4); }
        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: var(--navy);
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4); }
        .auth-links { text-align: center; margin-top: 20px; }
        .auth-links a { color: var(--navy); text-decoration: none; font-weight: 600; cursor: pointer; }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .alert-error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .alert-info { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-admin { background: var(--gold); color: var(--navy); }
        .badge-user { background: var(--navy); color: var(--white); }
        .app-container { display: none; min-height: 100vh; }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, var(--navy) 0%, #0d1642 100%);
            color: var(--white);
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid var(--gold); margin-bottom: 20px; }
        .sidebar-header h2 { color: var(--gold); font-size: 20px; margin-bottom: 5px; }
        .user-info { font-size: 12px; opacity: 0.9; margin-top: 10px; }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--white);
        }
        .menu-item:hover, .menu-item.active { background: rgba(255, 215, 0, 0.2); border-left: 4px solid var(--gold); }
        .menu-item span { margin-right: 10px; font-size: 20px; }
        .menu-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .menu-section-title { font-size: 11px; text-transform: uppercase; opacity: 0.6; margin-bottom: 10px; padding-left: 15px; }
        .main-content { margin-left: 260px; padding: 20px; min-height: 100vh; }
        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: var(--navy); font-size: 24px; }
        .header-actions { display: flex; gap: 10px; }
        .btn-icon {
            background: var(--light-gray);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        .btn-icon:hover { background: var(--gold); transform: scale(1.1); }
        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
        .card-title { color: var(--navy); font-size: 20px; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--gold);
        }
        .stat-value { font-size: 36px; font-weight: bold; color: var(--gold); margin: 10px 0; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: var(--navy); color: var(--white); font-weight: 600; font-size: 14px; }
        tr:hover { background: var(--light-gray); }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body { padding: 25px; }
        .close-btn { background: none; border: none; color: var(--white); font-size: 28px; cursor: pointer; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        textarea { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; resize: vertical; min-height: 100px; font-family: inherit; }
        .action-btns { display: flex; gap: 5px; }
        .btn-sm { padding: 8px 16px; font-size: 13px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-edit { background: #e3f2fd; color: #1565c0; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-view { background: #f3e5f5; color: #7b1fa2; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--light-gray); overflow-x: auto; }
        .tab { padding: 12px 20px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: var(--navy); border-bottom-color: var(--gold); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-selector { background: var(--gold); color: var(--navy); padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .user-selector select { flex: 1; padding: 8px; border-radius: 5px; border: none; font-weight: bold; }
        .copyright { text-align: center; padding: 20px; color: #666; font-size: 12px; border-top: 1px solid #e0e0e0; margin-top: 40px; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: var(--white); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-payment { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; text-align: center; transition: all 0.3s; }
        .btn-payment.selected { border-color: var(--gold); background: #fff8e1; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üè• ASM Gest√£o Cl√≠nica</h1>
                <p>Sistema Multi-Usu√°rio PRO</p>
            </div>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary"><span id="loginBtnText">Entrar</span></button>
            </form>
            <div class="auth-links">
                <p>Primeiro acesso? <a onclick="showScreen('registerScreen')">Criar conta Admin</a></p>
            </div>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 12px; color: #666;"><strong>CREFITO:</strong> 40.9314-F<br>Dra Andresa Augusto</p>
            </div>
        </div>
    </div>

    <!-- TELA DE CADASTRO ADMIN -->
    <div id="registerScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>üìù Criar Conta Admin</h1>
                <p>Configure sua cl√≠nica</p>
            </div>
            <div id="registerAlert"></div>
            <form id="registerForm">
                <div class="form-group">
                    <label>Nome da Cl√≠nica *</label>
                    <input type="text" id="regClinicName" required placeholder="Ex: Cl√≠nica Bem Estar">
                </div>
                <div class="form-group">
                    <label>Seu Nome Completo *</label>
                    <input type="text" id="regName" required placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label>E-mail *</label>
                    <input type="email" id="regEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label>Profiss√£o *</label>
                    <select id="regProfession" required>
                        <option value="">Selecione...</option>
                        <option value="Fisioterapeuta">Fisioterapeuta</option>
                        <option value="Psic√≥logo">Psic√≥logo</option>
                        <option value="Fonoaudi√≥logo">Fonoaudi√≥logo</option>
                        <option value="M√©dico">M√©dico</option>
                        <option value="Nutricionista">Nutricionista</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Senha *</label>
                    <input type="password" id="regPassword" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Senha *</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="Repita a senha">
                </div>
                <button type="submit" class="btn btn-primary"><span id="regBtnText">Criar Conta</span></button>
            </form>
            <div class="auth-links">
                <p>J√° tem conta? <a onclick="showScreen('loginScreen')">Fazer login</a></p>
            </div>
        </div>
    </div>

    <!-- TELA DE CONFIRMA√á√ÉO DE E-MAIL -->
    <div id="confirmScreen" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>‚úâÔ∏è Confirme seu E-mail</h1>
                <p>Quase l√°!</p>
            </div>
            <div class="alert alert-info">
                <strong>Enviamos um link de confirma√ß√£o para:</strong><br>
                <span id="confirmEmail" style="font-size: 18px; color: var(--navy);"></span>
            </div>
            <div style="background: #fff8e1; border-left: 4px solid var(--gold); padding: 15px; margin: 20px 0; border-radius: 5px; font-size: 14px;">
                <strong>üìã Passo a passo:</strong><br>
                1. Acesse seu e-mail<br>
                2. Clique no link de confirma√ß√£o<br>
                3. Volte aqui e clique em "J√° confirmei"
            </div>
            <button onclick="checkEmailConfirmed()" class="btn btn-primary">‚úÖ J√° confirmei meu e-mail</button>
            <button onclick="resendConfirmation()" class="btn btn-gold" style="margin-top: 10px;">üîÑ Reenviar e-mail</button>
            <div class="auth-links">
                <p><a onclick="showScreen('loginScreen')">Voltar para login</a></p>
            </div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div id="appContainer" class="app-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üè• ASM Cl√≠nica</h2>
                <div class="user-info">
                    <span id="sidebarUserName">Carregando...</span><br>
                    <span class="badge" id="sidebarUserRole">...</span>
                </div>
            </div>
            <div id="adminMenu" class="hidden">
                <div class="menu-section">
                    <div class="menu-section-title">Gest√£o</div>
                    <div class="menu-item active" onclick="showSection('dashboard')"><span>üìä</span> Dashboard</div>
                    <div class="menu-item" onclick="showSection('users')"><span>üë•</span> Usu√°rios</div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Operacional</div>
                <div class="menu-item" onclick="showSection('agenda')" id="menuAgenda"><span>üìÖ</span> Agenda Unificada</div>
                <div class="menu-item" onclick="showSection('pacientes')" id="menuPacientes"><span>üßë‚Äç‚öïÔ∏è</span> Meus Pacientes</div>
                <div class="menu-item" onclick="showSection('financeiro')" id="menuFinanceiro"><span>üí∞</span> Meu Financeiro</div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Relat√≥rios</div>
                <div class="menu-item" onclick="showSection('relatorios')"><span>üìà</span> Relat√≥rios</div>
            </div>
            <div class="menu-section">
                <div class="menu-item" onclick="logout()" style="color: #ff5252;"><span>üö™</span> Sair</div>
            </div>
        </nav>

        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn-icon" onclick="showProfile()" title="Meu Perfil">üë§</button>
                </div>
            </div>
            
            <div id="userSelector" class="user-selector hidden">
                <span>üëÅÔ∏è Visualizando como:</span>
                <select id="viewAsUser" onchange="changeUserView()"><option value="all">Todos os usu√°rios</option></select>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboardSection" class="section-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total Usu√°rios</div><div class="stat-value" id="statTotalUsers">1</div></div>
                    <div class="stat-card"><div class="stat-label">Pacientes Hoje</div><div class="stat-value" id="statTodayPatients">0</div></div>
                    <div class="stat-card"><div class="stat-label">Faturamento M√™s</div><div class="stat-value" id="statMonthRevenue">R$0</div></div>
                    <div class="stat-card"><div class="stat-label">Consultas Agendadas</div><div class="stat-value" id="statAppointments">0</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üë• Usu√°rios da Cl√≠nica</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('userModal')" style="background: var(--navy); color: white;">+ Novo Usu√°rio</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Nome</th><th>Profiss√£o</th><th>E-mail</th><th>Tipo</th><th>Status</th></tr></thead>
                            <tbody id="usersTableList"><tr><td colspan="5" style="text-align: center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- USU√ÅRIOS -->
            <div id="usersSection" class="section-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üë• Gerenciar Usu√°rios</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('userModal')" style="background: var(--navy); color: white;">+ Adicionar Profissional</button>
                    </div>
                    <div id="usersList"></div>
                </div>
            </div>

            <!-- AGENDA -->
            <div id="agendaSection" class="section-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìÖ Agenda Unificada</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('appointmentModal')" style="background: var(--navy); color: white;">+ Novo Agendamento</button>
                    </div>
                    <div id="agendaContent"></div>
                </div>
            </div>

            <!-- PACIENTES -->
            <div id="pacientesSection" class="section-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üßë‚Äç‚öïÔ∏è Meus Pacientes</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('patientModal')" style="background: var(--navy); color: white;">+ Novo Paciente</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Nome</th><th>Telefone</th><th>√öltima Consulta</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="patientsList"><tr><td colspan="4" style="text-align: center;">Nenhum paciente cadastrado</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FINANCEIRO -->
            <div id="financeiroSection" class="section-content hidden">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Entradas</div><div class="stat-value" id="finIncome">R$0</div></div>
                    <div class="stat-card"><div class="stat-label">Sa√≠das</div><div class="stat-value" id="finExpense">R$0</div></div>
                    <div class="stat-card"><div class="stat-label">Saldo</div><div class="stat-value" id="finBalance">R$0</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üí∞ Lan√ßamentos</h2>
                        <button class="btn-sm btn-primary" onclick="openModal('transactionModal')" style="background: var(--navy); color: white;">+ Novo Lan√ßamento</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Data</th><th>Paciente</th><th>Tipo</th><th>Valor</th><th>Pagamento</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="transactionsList"><tr><td colspan="6" style="text-align: center;">Nenhum lan√ßamento</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div id="relatoriosSection" class="section-content hidden">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üìà Relat√≥rios</h2></div>
                    <div class="tabs">
                        <button class="tab active" onclick="showTab('relFinanceiro')">Financeiro</button>
                        <button class="tab" onclick="showTab('relAtendimentos')">Atendimentos</button>
                        <button class="tab" onclick="showTab('relPacientes')">Pacientes</button>
                    </div>
                    <div id="relFinanceiro" class="tab-content active">
                        <p>Relat√≥rio financeiro ser√° implementado na pr√≥xima vers√£o</p>
                    </div>
                    <div id="relAtendimentos" class="tab-content">
                        <p>Relat√≥rio de atendimentos ser√° implementado na pr√≥xima vers√£o</p>
                    </div>
                    <div id="relPacientes" class="tab-content">
                        <p>Relat√≥rio de pacientes ser√° implementado na pr√≥xima vers√£o</p>
                    </div>
                </div>
            </div>

            <div class="copyright">
                <strong>ASM Gest√£o Cl√≠nica PRO</strong><br>
                Dra Andresa Augusto - CREFITO 40.9314-F<br>
                ¬© 2026 - Proibida reprodu√ß√£o sem autoriza√ß√£o
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>üë§ Novo Profissional</h3><button class="close-btn" onclick="closeModal('userModal')">&times;</button></div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group"><label>Nome Completo *</label><input type="text" id="userName" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>E-mail *</label><input type="email" id="userEmail" required></div>
                        <div class="form-group"><label>Profiss√£o *</label>
                            <select id="userProfession" required>
                                <option value="">Selecione...</option>
                                <option value="Fisioterapeuta">Fisioterapeuta</option>
                                <option value="Psic√≥logo">Psic√≥logo</option>
                                <option value="Fonoaudi√≥logo">Fonoaudi√≥logo</option>
                                <option value="M√©dico">M√©dico</option>
                                <option value="Nutricionista">Nutricionista</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label>Senha Tempor√°ria *</label><input type="password" id="userPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres"><small style="color: #666;">O usu√°rio poder√° alterar depois</small></div>
                    <button type="submit" class="btn btn-primary">üíæ Criar Usu√°rio</button>
                </form>
            </div>
        </div>
    </div>

    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>üßë‚Äç‚öïÔ∏è Novo Paciente</h3><button class="close-btn" onclick="closeModal('patientModal')">&times;</button></div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="form-group"><label>Nome Completo *</label><input type="text" id="patientName" required></div>
                    <div class="form-row">
                        <div class="form-group"><label>Telefone *</label><input type="text" id="patientPhone" required placeholder="(00) 00000-0000"></div>
                        <div class="form-group"><label>E-mail</label><input type="email" id="patientEmail" placeholder="opcional"></div>
                    </div>
                    <div class="form-group"><label>Data de Nascimento</label><input type="date" id="patientBirth"></div>
                    <div class="form-group"><label>Queixa Principal</label><textarea id="patientComplaint" placeholder="Descreva a queixa principal do paciente..."></textarea></div>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Paciente</button>
                </form>
            </div>
        </div>
    </div>

    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>üìÖ Novo Agendamento</h3><button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button></div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-group"><label>Paciente *</label><input type="text" id="appPatientName" required placeholder="Nome do paciente"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Data *</label><input type="date" id="appDate" required></div>
                        <div class="form-group"><label>Hora *</label><input type="time" id="appTime" required></div>
                    </div>
                    <div class="form-group"><label>Tipo de Atendimento *</label><input type="text" id="appType" required placeholder="Ex: Avalia√ß√£o, Sess√£o, Retorno..."></div>
                    <div class="form-group"><label>Valor (R$)</label><input type="number" id="appValue" step="0.01" placeholder="0,00"></div>
                    <div class="form-group"><label><input type="checkbox" id="appRecurring"> Paciente Fixo (Recorrente)</label></div>
                    <div id="recurringOptions" class="hidden" style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div class="form-group"><label>Repetir por quantas semanas?</label>
                            <select id="appWeeks">
                                <option value="4">4 semanas</option>
                                <option value="8">8 semanas</option>
                                <option value="12">12 semanas</option>
                                <option value="52">1 ano</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">üìÖ Agendar</button>
                </form>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>üí∞ Novo Lan√ßamento</h3><button class="close-btn" onclick="closeModal('transactionModal')">&times;</button></div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group"><label>Tipo *</label>
                            <select id="transType" required>
                                <option value="income">Entrada</option>
                                <option value="expense">Sa√≠da</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Valor (R$) *</label><input type="number" id="transValue" step="0.01" required placeholder="0,00"></div>
                    </div>
                    <div class="form-group"><label>Descri√ß√£o / Tipo de Atendimento *</label><input type="text" id="transDesc" required placeholder="Ex: Avalia√ß√£o Fisioterapia, Sess√£o Psicologia..."></div>
                    <div class="form-group"><label>Forma de Pagamento *</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn-payment" data-method="pix" onclick="selectPayment(this)">üí†<br>Pix</button>
                            <button type="button" class="btn-payment" data-method="dinheiro" onclick="selectPayment(this)">üíµ<br>Dinheiro</button>
                            <button type="button" class="btn-payment" data-method="cartao" onclick="selectPayment(this)">üí≥<br>Cart√£o</button>
                        </div>
                        <input type="hidden" id="transPaymentMethod" required>
                    </div>
                    <div class="form-group"><label>Data</label><input type="date" id="transDate" required></div>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Lan√ßamento</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE - SUBSTITUA SE NECESS√ÅRIO
        const SUPABASE_URL = 'https://nycjicdhwamnivfyhhst.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55Y2ppY2Rod2Ftbml2ZnloaHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDkwOTAsImV4cCI6MjA4NzEyNTA5MH0.c0TZ46vwHCu4Ta1AAlMEtipyvCv3eRNV33mtaxLNL7g';
        
        let supabase, currentUser = null, currentProfile = null, currentClinic = null, clinicUsers = [], viewingAsUser = null;

        function initSupabase() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            checkSession();
        }

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
            } else {
                showScreen('loginScreen');
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.remove('hidden');
        }

        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            const sectionEl = document.getElementById(section + 'Section');
            if (sectionEl) {
                sectionEl.classList.remove('hidden');
                sectionEl.classList.add('fade-in');
            }
            const titles = { dashboard: 'Dashboard', users: 'Gest√£o de Usu√°rios', agenda: 'Agenda Unificada', pacientes: 'Meus Pacientes', financeiro: 'Meu Financeiro', relatorios: 'Relat√≥rios' };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            if (section === 'dashboard') loadDashboard();
            if (section === 'users') loadUsers();
            if (section === 'agenda') loadAgenda();
            if (section === 'pacientes') loadPatients();
            if (section === 'financeiro') loadFinance();
        }

        function showTab(tabName) {
            event.target.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loginBtnText').innerHTML = '<span class="loading"></span>';
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                showAlert('loginAlert', error.message, 'error');
                document.getElementById('loginBtnText').textContent = 'Entrar';
            } else {
                currentUser = data.user;
                await loadUserProfile();
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('regBtnText').innerHTML = '<span class="loading"></span>';
            const clinicName = document.getElementById('regClinicName').value;
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const profession = document.getElementById('regProfession').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;
            if (password !== confirm) {
                showAlert('registerAlert', 'As senhas n√£o conferem!', 'error');
                document.getElementById('regBtnText').textContent = 'Criar Conta';
                return;
            }
            const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { name, role: 'admin' } } });
            if (error) {
                showAlert('registerAlert', error.message, 'error');
                document.getElementById('regBtnText').textContent = 'Criar Conta';
                return;
            }
            const { data: clinic } = await supabase.from('clinics').insert([{ name: clinicName, admin_id: data.user.id }]).select().single();
            await supabase.from('profiles').insert([{ id: data.user.id, clinic_id: clinic.id, name: name, email: email, profession: profession, role: 'admin', created_at: new Date().toISOString() }]);
            document.getElementById('confirmEmail').textContent = email;
            showScreen('confirmScreen');
        });

        async function checkEmailConfirmed() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await supabase.from('profiles').update({ activated_at: new Date().toISOString() }).eq('id', currentUser.id);
                await loadUserProfile();
            } else {
                showAlert('loginAlert', 'E-mail ainda n√£o confirmado. Verifique sua caixa de entrada.', 'error');
                showScreen('loginScreen');
            }
        }

        async function resendConfirmation() {
            const email = document.getElementById('confirmEmail').textContent;
            await supabase.auth.resend({ type: 'signup', email });
            alert('E-mail reenviado!');
        }

        async function loadUserProfile() {
            const { data: profile } = await supabase.from('profiles').select('*, clinics(*)').eq('id', currentUser.id).single();
            if (!profile) { showAlert('loginAlert', 'Perfil n√£o encontrado', 'error'); return; }
            currentProfile = profile;
            currentClinic = profile.clinics;
            document.getElementById('sidebarUserName').textContent = profile.name;
            document.getElementById('sidebarUserRole').textContent = profile.role === 'admin' ? 'ADMIN' : profile.profession;
            document.getElementById('sidebarUserRole').className = 'badge ' + (profile.role === 'admin' ? 'badge-admin' : 'badge-user');
            if (profile.role === 'admin') {
                document.getElementById('adminMenu').classList.remove('hidden');
                document.getElementById('userSelector').classList.remove('hidden');
                loadClinicUsers();
            } else {
                document.getElementById('adminMenu').classList.add('hidden');
                document.getElementById('userSelector').classList.add('hidden');
            }
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('appContainer').style.display = 'block';
            showSection('dashboard');
        }

        async function loadClinicUsers() {
            if (!currentClinic) return;
            const { data: users } = await supabase.from('profiles').select('*').eq('clinic_id', currentClinic.id);
            clinicUsers = users || [];
            const select = document.getElementById('viewAsUser');
            select.innerHTML = '<option value="all">Todos os usu√°rios</option>';
            clinicUsers.forEach(u => { select.innerHTML += `<option value="${u.id}">${u.name} (${u.profession})</option>`; });
            const tbody = document.getElementById('usersTableList');
            if (clinicUsers.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum usu√°rio</td></tr>'; }
            else { tbody.innerHTML = clinicUsers.map(u => `<tr><td><strong>${u.name}</strong></td><td>${u.profession}</td><td>${u.email}</td><td><span class="badge ${u.role === 'admin' ? 'badge-admin' : 'badge-user'}">${u.role === 'admin' ? 'Admin' : 'Profissional'}</span></td><td>Ativo</td></tr>`).join(''); }
            document.getElementById('statTotalUsers').textContent = clinicUsers.length;
        }

        function changeUserView() {
            const userId = document.getElementById('viewAsUser').value;
            viewingAsUser = userId === 'all' ? null : userId;
            const currentSection = document.querySelector('.section-content:not(.hidden)').id;
            if (currentSection === 'pacientesSection') loadPatients();
            if (currentSection === 'financeiroSection') loadFinance();
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const profession = document.getElementById('userProfession').value;
            const password = document.getElementById('userPassword').value;
            const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { name, role: 'user' } } });
            if (error) { alert('Erro: ' + error.message); return; }
            await supabase.from('profiles').insert([{ id: data.user.id, clinic_id: currentClinic.id, name: name, email: email, profession: profession, role: 'user', created_at: new Date().toISOString() }]);
            closeModal('userModal');
            loadClinicUsers();
            alert('Usu√°rio criado! Senha tempor√°ria: ' + password);
            document.getElementById('userForm').reset();
        });

        async function loadDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const { data: appointments } = await supabase.from('appointments').select('*').eq('clinic_id', currentClinic.id).eq('date', today);
            const { data: transactions } = await supabase.from('transactions').select('*').eq('clinic_id', currentClinic.id);
            document.getElementById('statTodayPatients').textContent = appointments ? appointments.length : 0;
            const monthRevenue = transactions ? transactions.filter(t => t.type === 'income' && t.date.startsWith(today.substring(0, 7))).reduce((sum, t) => sum + parseFloat(t.value), 0) : 0;
            document.getElementById('statMonthRevenue').textContent = 'R$' + monthRevenue.toFixed(2);
            document.getElementById('statAppointments').textContent = appointments ? appointments.length : 0;
        }

        async function loadAgenda() {
            const { data: appointments } = await supabase.from('appointments').select('*, profiles(name)').eq('clinic_id', currentClinic.id).order('date', { ascending: true });
            const container = document.getElementById('agendaContent');
            if (!appointments || appointments.length === 0) { container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum agendamento</p>'; return; }
            container.innerHTML = '<div class="table-container"><table><thead><tr><th>Data</th><th>Hora</th><th>Paciente</th><th>Profissional</th><th>Tipo</th><th>Valor</th></tr></thead><tbody>' + 
                appointments.map(a => `<tr><td>${formatDate(a.date)}</td><td>${a.time}</td><td>${a.patient_name}</td><td>${a.profiles ? a.profiles.name : '-'}</td><td>${a.type || '-'}</td><td>R$ ${a.value || '0,00'}</td></tr>`).join('') + 
                '</tbody></table></div>';
        }

        async function loadPatients() {
            let query = supabase.from('patients').select('*').eq('clinic_id', currentClinic.id);
            if (viewingAsUser) query = query.eq('user_id', viewingAsUser);
            else if (currentProfile.role !== 'admin') query = query.eq('user_id', currentUser.id);
            const { data: patients } = await query;
            const tbody = document.getElementById('patientsList');
            if (!patients || patients.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum paciente cadastrado</td></tr>'; return; }
            tbody.innerHTML = patients.map(p => `<tr><td><strong>${p.name}</strong></td><td>${p.phone || '-'}</td><td>${p.last_visit ? formatDate(p.last_visit) : 'Nunca'}</td><td><div class="action-btns"><button class="btn-sm btn-view" onclick="viewPatient('${p.id}')">üëÅÔ∏è</button><button class="btn-sm btn-edit" onclick="editPatient('${p.id}')">‚úèÔ∏è</button><button class="btn-sm btn-delete" onclick="deletePatient('${p.id}')">üóëÔ∏è</button></div></td></tr>`).join('');
        }

        async function loadFinance() {
            let query = supabase.from('transactions').select('*').eq('clinic_id', currentClinic.id);
            if (viewingAsUser) query = query.eq('user_id', viewingAsUser);
            else if (currentProfile.role !== 'admin') query = query.eq('user_id', currentUser.id);
            const { data: transactions } = await query.order('date', { ascending: false });
            let income = 0, expense = 0;
            const tbody = document.getElementById('transactionsList');
            if (!transactions || transactions.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum lan√ßamento</td></tr>'; }
            else {
                tbody.innerHTML = transactions.map(t => {
                    if (t.type === 'income') income += parseFloat(t.value); else expense += parseFloat(t.value);
                    return `<tr><td>${formatDate(t.date)}</td><td>${t.description}</td><td><span class="badge ${t.type === 'income' ? 'badge-admin' : 'badge-user'}">${t.type === 'income' ? 'Entrada' : 'Sa√≠da'}</span></td><td>R$ ${parseFloat(t.value).toFixed(2)}</td><td>${t.payment_method || '-'}</td><td><button class="btn-sm btn-delete" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button></td></tr>`;
                }).join('');
            }
            document.getElementById('finIncome').textContent = 'R$' + income.toFixed(2);
            document.getElementById('finExpense').textContent = 'R$' + expense.toFixed(2);
            document.getElementById('finBalance').textContent = 'R$' + (income - expense).toFixed(2);
        }

        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const patientData = { user_id: currentUser.id, clinic_id: currentClinic.id, name: document.getElementById('patientName').value, phone: document.getElementById('patientPhone').value, email: document.getElementById('patientEmail').value, birth_date: document.getElementById('patientBirth').value, complaint: document.getElementById('patientComplaint').value, created_at: new Date().toISOString() };
            await supabase.from('patients').insert([patientData]);
            closeModal('patientModal');
            loadPatients();
            document.getElementById('patientForm').reset();
        });

        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const appData = { user_id: currentUser.id, clinic_id: currentClinic.id, patient_name: document.getElementById('appPatientName').value, date: document.getElementById('appDate').value, time: document.getElementById('appTime').value, type: document.getElementById('appType').value, value: document.getElementById('appValue').value, is_recurring: document.getElementById('appRecurring').checked, created_at: new Date().toISOString() };
            await supabase.from('appointments').insert([appData]);
            if (document.getElementById('appRecurring').checked) {
                const weeks = parseInt(document.getElementById('appWeeks').value);
                for (let i = 1; i < weeks; i++) {
                    const nextDate = new Date(appData.date);
                    nextDate.setDate(nextDate.getDate() + (7 * i));
                    await supabase.from('appointments').insert([{ ...appData, date: nextDate.toISOString().split('T')[0], is_recurring: false }]);
                }
            }
            closeModal('appointmentModal');
            loadAgenda();
            document.getElementById('appointmentForm').reset();
        });

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const transData = { user_id: currentUser.id, clinic_id: currentClinic.id, type: document.getElementById('transType').value, value: document.getElementById('transValue').value, description: document.getElementById('transDesc').value, payment_method: document.getElementById('transPaymentMethod').value, date: document.getElementById('transDate').value, created_at: new Date().toISOString() };
            await supabase.from('transactions').insert([transData]);
            closeModal('transactionModal');
            loadFinance();
            document.getElementById('transactionForm').reset();
        });

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function selectPayment(btn) {
            document.querySelectorAll('.btn-payment').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('transPaymentMethod').value = btn.dataset.method;
        }
        function showAlert(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `alert alert-${type}`;
            el.textContent = message;
            setTimeout(() => el.textContent = '', 5000);
        }
        function formatDate(dateStr) { if (!dateStr) return '-'; const [year, month, day] = dateStr.split('-'); return `${day}/${month}/${year}`; }
        async function logout() { await supabase.auth.signOut(); location.reload(); }
        function showProfile() { alert('Perfil - em desenvolvimento'); }
        function viewPatient(id) { alert('Ver paciente ' + id); }
        function editPatient(id) { alert('Editar paciente ' + id); }
        async function deletePatient(id) { if (!confirm('Excluir paciente?')) return; await supabase.from('patients').delete().eq('id', id); loadPatients(); }
        async function deleteTransaction(id) { if (!confirm('Excluir lan√ßamento?')) return; await supabase.from('transactions').delete().eq('id', id); loadFinance(); }
        document.getElementById('appRecurring')?.addEventListener('change', function() { document.getElementById('recurringOptions').classList.toggle('hidden', !this.checked); });
        window.onload = initSupabase;
    </script>
</body>
</html>
